<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>GreenRide - Profile</title>

    <link rel="stylesheet" th:href="@{/css/greenride.css}">
    <link rel="stylesheet" th:href="@{/css/profile.css}">

    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
</head>
<body>

<header class="topbar">
    <a class="brand" th:href="@{/}">
        <iconify-icon icon="mdi:leaf" width="24" height="24" style="color: #fff"></iconify-icon>
        <span class="name">GreenRide</span>
    </a>

    <div class="top-actions">
        <form th:action="@{/logout}" method="post" class="logout-form">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit" class="pill-btn logout-btn">Logout</button>
        </form>
    </div>
</header>

<main class="profile-page">
    <h1 class="profile-title" th:text="${displayName}">Name Surname</h1>

    <form th:if="${adminViewingUserId != null}"
          th:action="@{/admin/users/{id}/delete(id=${adminViewingUserId})}"
          method="post"
          style="margin-bottom: 20px;">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button class="btn btn-danger" type="submit">
            Deactivate (Delete) User
        </button>
    </form>

    <div class="profile-columns">

        <section class="profile-col">
            <h2 class="profile-subtitle">Past Trips</h2>

            <div class="trip-list">

                <div class="trip-card" th:each="pt : ${pastTrips}">
                    <div class="trip-meta">
                        <span class="role-pill"
                              th:text="${pt.roleLabel()}"
                              th:classappend="${pt.roleLabel() == 'Driver'} ? ' driver' : ' passenger'">
                            Driver
                        </span>
                    </div>

                    <div class="trip-info">
                        <div class="trip-line strong"
                             th:text="${pt.trip().startingPoint() + ' - ' + pt.trip().destination()}">
                            Starting Point - Destination
                        </div>

                        <div class="trip-line"
                             th:text="${pt.trip().departureTime() != null
                                 ? #temporals.format(pt.trip().departureTime(), 'dd/MM/yyyy HH:mm')
                                 : '-'}">
                            Departure Time
                        </div>

                        <!-- Passengers count -->
                        <div class="trip-line"
                             th:text="${'Passengers: ' + (pt.trip().passengers() != null ? pt.trip().passengers().size() : 0)}">
                            Passengers: 0
                        </div>
                    </div>

                    <div class="trip-actions">
                        <a class="btn btn-details"
                           th:href="@{/trips/{id}(id=${pt.trip().id()})}">
                            Details
                        </a>
                    </div>
                </div>

                <div class="trip-card" th:if="${pastTrips == null || #lists.isEmpty(pastTrips)}">
                    <div class="trip-info">
                        <div class="trip-line strong">No past trips</div>
                        <div class="trip-line">—</div>
                        <div class="trip-line">—</div>
                    </div>
                </div>

            </div>
        </section>

        <div class="divider"></div>

        <!-- ================= RIGHT: REVIEWS ================= -->
        <section class="profile-col">
            <h2 class="profile-subtitle">Review Center</h2>

            <div class="review-filter">
                <span class="filter-label">Filter By:</span>

                <!-- ===== NORMAL USER MODE ===== -->
                <a th:if="${adminViewingUserId == null}"
                   class="filter-pill"
                   th:classappend="${reviewsFilter == 'to'} ? ' active' : ''"
                   th:href="@{/profile(reviews='to')}">
                    Regarding Me
                </a>

                <a th:if="${adminViewingUserId == null}"
                   class="filter-pill"
                   th:classappend="${reviewsFilter == 'from'} ? ' active' : ''"
                   th:href="@{/profile(reviews='from')}">
                    From Me
                </a>

                <!-- ===== ADMIN VIEW MODE ===== -->
                <a th:if="${adminViewingUserId != null}"
                   class="filter-pill"
                   th:classappend="${reviewsFilter == 'to'} ? ' active' : ''"
                   th:href="@{/admin/users/{id}(id=${adminViewingUserId},reviews='to')}">
                    Regarding User
                </a>

                <a th:if="${adminViewingUserId != null}"
                   class="filter-pill"
                   th:classappend="${reviewsFilter == 'from'} ? ' active' : ''"
                   th:href="@{/admin/users/{id}(id=${adminViewingUserId},reviews='from')}">
                    From User
                </a>
            </div>

            <div class="review-list">

                <div class="review-card" th:each="r : ${reviews}">
                    <p><strong>Reviewer:</strong>
                        <span th:text="${r.reviewer() != null ? r.reviewer().username() : '-'}">-</span>
                    </p>

                    <p><strong>Reviewee:</strong>
                        <span th:text="${r.reviewee() != null ? r.reviewee().username() : '-'}">-</span>
                    </p>

                    <p><strong>Rating:</strong>
                        <span th:text="${r.rating()}">-</span>
                    </p>

                    <p><strong>Comments:</strong>
                        <span th:text="${r.comments()}">-</span>
                    </p>
                </div>

                <div class="review-card" th:if="${reviews == null || #lists.isEmpty(reviews)}">
                    <p><strong>No reviews</strong></p>
                    <p>Nothing to show.</p>
                </div>

            </div>
        </section>

    </div>
</main>

</body>
</html>
